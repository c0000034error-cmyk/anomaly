<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <!-- –í–ê–ñ–ù–û: –ó–∞–ø—Ä–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –º–æ–±–∏–ª–æ–∫ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>OBSERVATION DUTY: MOBILE</title>
    <style>
        :root {
            --bg-color: #050505;
            --ui-bg: #141414;
            --text: #00ff41;
            --text-dim: #005515;
            --alert: #ff3333;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; background: #000; 
            width: 100vw; height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic viewport height –¥–ª—è –º–æ–±–∏–ª–æ–∫ */
            font-family: 'Courier New', monospace; 
            overflow: hidden; user-select: none; 
            display: flex; 
        }

        /* --- –≠–ö–†–ê–ù –ü–û–í–û–†–û–¢–ê (–¢–æ–ª—å–∫–æ –¥–ª—è –ø–æ—Ä—Ç—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞) --- */
        #rotate-msg {
            position: fixed; inset: 0; z-index: 9999;
            background: black; color: var(--text);
            display: none; flex-direction: column; 
            justify-content: center; align-items: center;
            text-align: center; padding: 20px;
        }
        #rotate-msg h1 { font-size: 40px; margin-bottom: 20px; }
        #rotate-msg span { font-size: 60px; animation: rotate-anim 2s infinite ease-in-out; display: block; }
        
        @keyframes rotate-anim {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(-90deg); }
            100% { transform: rotate(0deg); }
        }

        /* –ú–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å: –µ—Å–ª–∏ –≤—ã—Å–æ—Ç–∞ –±–æ–ª—å—à–µ —à–∏—Ä–∏–Ω—ã (–ø–æ—Ä—Ç—Ä–µ—Ç–Ω—ã–π —Ä–µ–∂–∏–º) */
        @media (orientation: portrait) {
            #rotate-msg { display: flex; }
            #game-container { display: none !important; }
            #fullscreen-msg { display: none !important; }
        }

        /* --- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† --- */
        #game-container {
            display: flex; width: 100%; height: 100%;
        }

        /* --- –ú–û–ù–ò–¢–û–† (–°–ª–µ–≤–∞) --- */
        #monitor-frame {
            flex: 3; /* –ó–∞–Ω–∏–º–∞–µ—Ç 75% —ç–∫—Ä–∞–Ω–∞ */
            background: #0a0a0a; 
            padding: 1vh; /* –û—Ç—Å—Ç—É–ø—ã –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –æ—Ç –≤—ã—Å–æ—Ç—ã */
            display: flex; flex-direction: column; position: relative;
        }
        #screen {
            flex-grow: 1; background: #000; position: relative;
            border: 2px solid #222; overflow: hidden;
            box-shadow: inset 0 0 50px #000;
        }
        
        /* –≠–§–§–ï–ö–¢–´ */
        #scanlines {
            position: absolute; inset: 0; pointer-events: none; z-index: 50;
            background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.1) 50%); background-size: 100% 4px;
        }
        #static {
            position: absolute; inset: 0; pointer-events: none; z-index: 60; opacity: 1;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.65"/></filter><rect width="100%" height="100%" filter="url(%23n)"/></svg>');
            transition: opacity 0.3s;
        }
        #cam-info {
            position: absolute; top: 5%; left: 3%; color: white;
            background: rgba(0,0,0,0.6); padding: 2px 10px; z-index: 40; 
            font-size: 4vh; /* –®—Ä–∏—Ñ—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞ */
            border-left: 3px solid var(--text);
        }
        #level-indicator {
            position: absolute; top: 5%; right: 3%; color: var(--text);
            font-weight: bold; z-index: 40; font-size: 4vh; 
            text-shadow: 0 0 10px var(--text);
        }
        #rec-dot {
            position: absolute; top: 6%; right: 25%; width: 2vh; height: 2vh;
            background: red; border-radius: 50%; z-index: 40; animation: blink 1s infinite;
        }

        /* --- –ü–£–õ–¨–¢ (–°–ø—Ä–∞–≤–∞) --- */
        #control-panel {
            flex: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç 25% —ç–∫—Ä–∞–Ω–∞ */
            background: var(--ui-bg); border-left: 2px solid #333;
            display: flex; flex-direction: column; padding: 5px; gap: 5px;
            min-width: 140px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ */
        }
        
        #status-display { 
            font-size: 2.5vh; color: #888; text-align: center; 
            border: 1px solid #333; padding: 2px; background: #000; 
            margin-bottom: 2px; height: 5vh; display: flex; align-items: center; justify-content: center;
            white-space: nowrap; overflow: hidden;
        }
        
        #cam-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 4px; flex-grow: 1;
        }
        .cam-btn {
            background: #050505; color: #555; border: 1px solid #333;
            cursor: pointer; font-weight: bold; transition: 0.1s; 
            font-size: 2.5vh; /* –ö—Ä—É–ø–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è –ø–∞–ª—å—Ü–µ–≤ */
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            touch-action: manipulation;
        }
        .cam-btn span { font-size: 1.5vh; margin-top: 2px; color: #444; }
        .cam-btn:active { background: #333; }
        .cam-btn.active { color: black; background: var(--text); border-color: white; }
        .cam-btn.active span { color: #003300; }

        .action-btn {
            padding: 1vh; font-size: 2.5vh; font-weight: bold; cursor: pointer; border: none; text-transform: uppercase;
            height: 8vh;
        }
        #report-btn { background: #400; color: white; border: 1px solid red; }
        #report-btn:active { background: red; color: black; }
        #clean-btn { background: #002200; color: #0f0; border: 1px solid #0f0; margin-top: 2px;}
        #clean-btn:active { background: #0f0; color: black; }

        /* --- –ú–ï–ù–Æ –†–ï–ü–û–†–¢–ê --- */
        #report-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 100;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .rep-group { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 95%; height: 70%;
        }
        .rep-type {
            background: #222; border: 1px solid #555;
            color: white; cursor: pointer; text-align: center; font-size: 2.5vh; 
            display: flex; align-items: center; justify-content: center;
        }
        .rep-type:active { background: white; color: black; }

        /* --- –ö–û–ú–ù–ê–¢–´ (–í–∏–∑—É–∞–ª) --- */
        .room-container {
            width: 100%; height: 100%; position: absolute; background: #111; display: none; overflow: hidden;
        }
        .room-container.visible { display: block; }
        
        .wall { 
            position: absolute; top: 0; left: 0; width: 100%; height: 75%; 
            background: #444; z-index: 0; 
            box-shadow: inset 0 0 100px rgba(0,0,0,1);
        }
        .floor { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 25%; 
            background: #222; z-index: 1; border-top: 2px solid #000; 
            background-image: repeating-linear-gradient(45deg, #222 25%, transparent 25%, transparent 75%, #222 75%, #222), repeating-linear-gradient(45deg, #222 25%, #1a1a1a 25%, #1a1a1a 75%, #222 75%, #222);
            background-position: 0 0, 10px 10px; background-size: 20px 20px;
        }

        .obj { 
            position: absolute; box-sizing: border-box; 
            transition: all 0.2s ease-out; z-index: 10;
            display: flex; align-items: center; justify-content: center;
            text-align: center; font-weight: bold;
        }

        /* –û–±—ä–µ–∫—Ç—ã */
        .poster { background: #ddd; color: black; border: 2px solid #111; font-family: 'Impact', sans-serif; letter-spacing: 1px; font-size: 2vh; }
        .window { background: #000510; border: 4px solid #222; overflow: hidden; }
        .window::before, .window::after { content:''; position:absolute; background:#222; }
        .window::before { top:0; left:50%; width:4px; height:100%; }
        .window::after { top:50%; left:0; width:100%; height:4px; }
        .furniture { background: #4e342e; border: 1px solid #222; box-shadow: 5px 5px 10px rgba(0,0,0,0.5); }
        .deco-emoji { font-size: 4vh; opacity: 0.7; z-index: 2; pointer-events: none; }
        
        /* –ê–Ω–æ–º–∞–ª–∏–∏ */
        .ghost { 
            position: absolute; width: 8vh; height: 20vh; background: black; 
            border-radius: 50% 50% 0 0; filter: blur(6px); opacity: 0.95; z-index: 30; pointer-events: none;
        }
        .intruder-face {
            position: absolute; font-size: 10vh; color: #444; opacity: 0.3; z-index: 5;
            filter: blur(2px); top: 10%; left: 20%;
        }

        /* –≠–∫—Ä–∞–Ω—ã –º–µ–Ω—é */
        #fullscreen-msg {
            position: fixed; inset: 0; background: black; z-index: 200;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 3vh; text-align: center; padding: 20px; 
        }
        .result-box {
            border: 1px solid #555; background: #111; padding: 15px; margin: 10px; max-width: 90%;
        }

        @keyframes blink { 50% { opacity: 0; } }
        .scary-text { color: red !important; font-family: 'Chiller', 'Courier', serif !important; transform: scale(1.1); }
        .scary-filter { filter: invert(1) contrast(1.5); }
        .blood-filter { box-shadow: inset 0 0 100px rgba(255,0,0,0.5); }

    </style>
</head>
<body>

    <!-- –ó–ê–ì–õ–£–®–ö–ê –î–õ–Ø –ü–û–†–¢–†–ï–¢–ù–û–ì–û –†–ï–ñ–ò–ú–ê -->
    <div id="rotate-msg">
        <h1>–ü–û–í–ï–†–ù–ò–¢–ï –£–°–¢–†–û–ô–°–¢–í–û</h1>
        <span>üì±</span>
        <p style="color:#555; margin-top:20px;">–ò–≥—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ<br>–≤ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ</p>
    </div>

    <!-- –≠–ö–†–ê–ù –°–¢–ê–†–¢–ê / –ì–ï–ô–ú–û–í–ï–†–ê -->
    <div id="fullscreen-msg">
        <h1 id="msg-title" style="color:var(--text); font-size: 8vh; margin: 0;">–û–¢–î–ï–õ –ù–ê–ë–õ–Æ–î–ï–ù–ò–Ø</h1>
        <div class="result-box">
            <p id="msg-body" style="color:#ccc; line-height: 1.4; font-size: 2.5vh;">
                –ó–ê–î–ê–ß–ê: –î–û–ô–¢–ò –î–û –£–†–û–í–ù–Ø 20.<br><br>
                <span style="color:var(--text)">–í–ù–ò–ú–ê–ù–ò–ï:</span> –ù–∞–±–ª—é–¥–∞–π—Ç–µ 5-10 —Å–µ–∫.<br>
                –ê–Ω–æ–º–∞–ª–∏–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –Ω–µ —Å—Ä–∞–∑—É.<br><br>
                –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏–≥—Ä–∞—Ç—å —Å–æ –∑–≤—É–∫–æ–º.
            </p>
        </div>
        <button onclick="initGame()" style="padding: 2vh 5vh; font-size: 4vh; background: var(--text); border: none; cursor: pointer; font-weight: bold; margin-top: 20px; border-radius: 5px;">–ù–ê–ß–ê–¢–¨</button>
    </div>

    <!-- –û–°–ù–û–í–ù–ê–Ø –ò–ì–†–ê -->
    <div id="game-container">
        <div id="monitor-frame">
            <div id="screen">
                <div id="scanlines"></div>
                <div id="static"></div>
                <div id="rec-dot"></div>
                <div id="cam-info">CAM 1</div>
                <div id="level-indicator">LVL 1</div>
                
                <div id="rooms-mount"></div>

                <!-- –ú–ï–ù–Æ –†–ï–ü–û–†–¢–ê -->
                <div id="report-overlay">
                    <h2 style="color:var(--text); margin: 1vh; font-size: 4vh;">–¢–ò–ü –ê–ù–û–ú–ê–õ–ò–ò</h2>
                    <div class="rep-group">
                        <div class="rep-type" onclick="checkAnswer('ghost')">üëª –ü–†–ò–ó–†–ê–ö / –¢–ï–ù–¨</div>
                        <div class="rep-type" onclick="checkAnswer('move')">üì¶ –ü–ï–†–ï–ú–ï–©–ï–ù–ò–ï</div>
                        <div class="rep-type" onclick="checkAnswer('extra')">‚ûï –õ–ò–®–ù–ò–ô –ü–†–ï–î–ú–ï–¢</div>
                        <div class="rep-type" onclick="checkAnswer('missing')">üí® –ò–°–ß–ï–ó–ù–û–í–ï–ù–ò–ï</div>
                        <div class="rep-type" onclick="checkAnswer('emoji')">üòà –õ–ò–¶–û / –≠–ú–û–î–ó–ò</div>
                        <div class="rep-type" onclick="checkAnswer('text')">üî§ –¢–ï–ö–°–¢</div>
                        <div class="rep-type" onclick="checkAnswer('camera')">üìπ –°–ë–û–ô –ö–ê–ú–ï–†–´</div>
                        <div class="rep-type" onclick="checkAnswer('intruder')">üëÅÔ∏è –û–ö–ù–û</div>
                    </div>
                    <button class="rep-type" style="border-color:red; color:red; margin-top:10px; width: 50%; height: 10%; background: #200;" onclick="toggleReport()">–û–¢–ú–ï–ù–ê</button>
                </div>
            </div>
        </div>

        <div id="control-panel">
            <div id="status-display">–ó–ê–ì–†–£–ó–ö–ê...</div>
            
            <div id="cam-grid">
                <button class="cam-btn active" onclick="switchCam(0)">1<span>–°–ü–ê–õ–¨–ù–Ø</span></button>
                <button class="cam-btn" onclick="switchCam(1)">2<span>–ö–£–•–ù–Ø</span></button>
                <button class="cam-btn" onclick="switchCam(2)">3<span>–ó–ê–õ</span></button>
                <button class="cam-btn" onclick="switchCam(3)">4<span>–í–ê–ù–ù–ê–Ø</span></button>
                <button class="cam-btn" onclick="switchCam(4)">5<span>–ö–û–†–ò–î–û–†</span></button>
                <button class="cam-btn" onclick="switchCam(5)">6<span>–ü–û–î–í–ê–õ</span></button>
            </div>

            <button class="action-btn" id="clean-btn" onclick="checkAnswer('none')">‚úÖ –ß–ò–°–¢–û</button>
            <button class="action-btn" id="report-btn" onclick="toggleReport()">‚ö†Ô∏è –†–ï–ü–û–†–¢</button>
        </div>
    </div>

    <script>
        /* --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø --- */
        const MAX_LEVEL = 20;
        
        // –®–∞–±–ª–æ–Ω—ã –∫–æ–º–Ω–∞—Ç
        const ROOM_LAYOUTS = [
            {
                name: "–°–ü–ê–õ–¨–ù–Ø", wall: "#504040",
                items: [
                    { id: 'bed', type: 'furniture', bg:'#777', w:35, h:20, x:10, y:65, z:5 },
                    { id: 'win', type: 'window', w:20, h:30, x:40, y:10, z:1 },
                    { id: 'poster', type: 'poster', text:'DREAM', w:12, h:15, x:75, y:20, z:2 },
                    { id: 'toy', type: 'obj', text:'üß∏', w:5, h:5, x:15, y:60, z:6, style:'font-size:5vh;' },
                    { id: 'clock', type: 'obj', text:'‚è∞', w:5, h:5, x:85, y:65, z:5, style:'font-size:4vh;' }
                ]
            },
            {
                name: "–ö–£–•–ù–Ø", wall: "#606060",
                items: [
                    { id: 'fridge', type: 'furniture', bg:'#ddd', w:18, h:50, x:5, y:25, z:4 },
                    { id: 'table', type: 'furniture', bg:'#4e342e', w:30, h:20, x:35, y:60, z:5 },
                    { id: 'win2', type: 'window', w:25, h:20, x:40, y:10, z:1 },
                    { id: 'cup', type: 'obj', text:'‚òï', w:5, h:5, x:45, y:55, z:6, style:'font-size:3vh;' },
                    { id: 'poster2', type: 'poster', text:'EAT', w:10, h:10, x:80, y:20, z:2 },
                    { id: 'plant', type: 'obj', text:'üåø', w:5, h:5, x:85, y:50, z:5, style:'font-size:6vh;' }
                ]
            },
            {
                name: "–ó–ê–õ", wall: "#4a3b32",
                items: [
                    { id: 'sofa', type: 'furniture', bg:'#3e2723', w:45, h:15, x:25, y:65, z:5, style:'border-radius:10px 10px 0 0' },
                    { id: 'tv', type: 'obj', bg:'#111', w:25, h:18, x:70, y:45, z:4, style:'border:2px solid #444' },
                    { id: 'paint', type: 'poster', text:'HOME', w:15, h:20, x:10, y:15, z:1, style:'background:#543; color:#fff;' },
                    { id: 'cat', type: 'obj', text:'üêà', w:5, h:5, x:30, y:60, z:6, style:'font-size:5vh;' },
                    { id: 'lamp', type: 'obj', text:'üõãÔ∏è', w:5, h:5, x:5, y:65, z:5, style:'font-size:6vh;' }
                ]
            },
            {
                name: "–í–ê–ù–ù–ê–Ø", wall: "#37474f", 
                items: [
                    { id: 'mirror', type: 'obj', bg:'#aaddff', w:15, h:20, x:42, y:15, z:2, style:'border:3px solid silver' },
                    { id: 'bath', type: 'furniture', bg:'#eee', w:40, h:25, x:5, y:55, z:4 },
                    { id: 'duck', type: 'obj', text:'ü¶Ü', w:5, h:5, x:20, y:50, z:6, style:'font-size:3vh;' },
                    { id: 'toilet', type: 'obj', text:'üöΩ', w:10, h:10, x:80, y:60, z:4, style:'font-size:8vh;' },
                    { id: 'soap', type: 'obj', text:'üßº', w:5, h:5, x:45, y:40, z:5, style:'font-size:3vh;' }
                ]
            },
            {
                name: "–ö–û–†–ò–î–û–†", wall: "#5d4037",
                items: [
                    { id: 'door', type: 'obj', bg:'#2e1c11', w:15, h:55, x:42, y:20, z:1, style:'border:2px solid black' },
                    { id: 'exit', type: 'poster', text:'EXIT', bg:'green', w:12, h:6, x:43, y:10, z:2, style:'color:white; font-size:1.5vh;' },
                    { id: 'shoes', type: 'obj', text:'üëü', w:5, h:5, x:35, y:70, z:5, style:'font-size:4vh;' },
                    { id: 'umbrella', type: 'obj', text:'üåÇ', w:5, h:5, x:60, y:65, z:5, style:'font-size:5vh;' }
                ]
            },
            {
                name: "–ü–û–î–í–ê–õ", wall: "#1a1a1a",
                items: [
                    { id: 'shelf', type: 'furniture', bg:'#333', w:30, h:60, x:10, y:15, z:2 },
                    { id: 'box', type: 'obj', text:'üì¶', w:10, h:10, x:15, y:20, z:3, style:'font-size:6vh;' },
                    { id: 'box2', type: 'obj', text:'üì¶', w:10, h:10, x:20, y:50, z:3, style:'font-size:6vh;' },
                    { id: 'skull', type: 'obj', text:'üíÄ', w:5, h:5, x:80, y:70, z:4, style:'font-size:5vh; opacity:0.5' },
                    { id: 'web', type: 'obj', text:'üï∏Ô∏è', w:10, h:10, x:85, y:5, z:5, style:'font-size:8vh; opacity:0.6' }
                ]
            }
        ];

        /* --- STATE --- */
        let currentLevel = 1;
        let currentCam = 0;
        let anomalyData = { active: false, type: 'none', roomId: -1, description: '' };
        let anomalyTimer = null;
        let isGameOver = false;
        
        const AudioSys = {
            ctx: null,
            init: function() { 
                if(!this.ctx) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext(); 
                }
                // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –º–æ–±–∏–ª–æ–∫
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },
            play: function(type) {
                if(!this.ctx) return;
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.connect(g); g.connect(this.ctx.destination);
                
                if(type === 'static') {
                    const bSize = this.ctx.sampleRate * 0.2;
                    const b = this.ctx.createBuffer(1, bSize, this.ctx.sampleRate);
                    const d = b.getChannelData(0);
                    for(let i=0; i<bSize; i++) d[i] = Math.random() * 2 - 1;
                    const src = this.ctx.createBufferSource();
                    src.buffer = b;
                    src.connect(g); g.connect(this.ctx.destination);
                    g.gain.value = 0.05;
                    src.start();
                    return;
                }

                if(type === 'bad') {
                    o.type = 'sawtooth'; o.frequency.value = 80;
                    o.frequency.linearRampToValueAtTime(40, this.ctx.currentTime + 0.5);
                    g.gain.value = 0.3;
                    o.start(); o.stop(this.ctx.currentTime + 0.5);
                } else { // good
                    o.type = 'sine'; o.frequency.value = 600;
                    o.frequency.exponentialRampToValueAtTime(1000, this.ctx.currentTime + 0.1);
                    g.gain.value = 0.1;
                    o.start(); o.stop(this.ctx.currentTime + 0.15);
                }
            }
        };

        /* --- INITIALIZATION --- */
        function initGame() {
            // –ü–æ–ø—ã—Ç–∫–∞ –≤–∫–ª—é—á–∏—Ç—å Fullscreen (—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ –Ω–∞–∂–∞—Ç–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
            const docEl = document.documentElement;
            if (docEl.requestFullscreen) {
                docEl.requestFullscreen().catch(err => console.log("Fullscreen blocked"));
            } else if (docEl.webkitRequestFullscreen) { /* Safari */
                docEl.webkitRequestFullscreen();
            } else if (docEl.msRequestFullscreen) { /* IE11 */
                docEl.msRequestFullscreen();
            }

            document.getElementById('fullscreen-msg').style.display = 'none';
            isGameOver = false;
            AudioSys.init();
            
            // 1. –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–º–Ω–∞—Ç
            const mount = document.getElementById('rooms-mount');
            mount.innerHTML = '';
            
            ROOM_LAYOUTS.forEach((layout, idx) => {
                const r = document.createElement('div');
                r.className = 'room-container';
                r.id = `room-${idx}`;
                if(idx === 0) r.classList.add('visible');
                
                const w = document.createElement('div'); w.className = 'wall'; w.style.background = layout.wall;
                const f = document.createElement('div'); f.className = 'floor';
                r.appendChild(w); r.appendChild(f);

                layout.items.forEach((item, itemIdx) => {
                    createObject(r, item, idx, itemIdx);
                });

                addRandomClutter(r, idx);
                mount.appendChild(r);
            });

            startLevel(1);
        }

        function createObject(parent, item, roomId, objIdPrefix) {
            const el = document.createElement('div');
            el.className = `obj ${item.type}`;
            el.id = `r${roomId}-${objIdPrefix}`; 
            el.style.left = item.x + '%';
            el.style.top = item.y + '%';
            el.style.width = item.w + '%';
            el.style.height = item.h + '%';
            el.style.zIndex = item.z;
            if(item.bg) el.style.background = item.bg;
            if(item.text) el.innerText = item.text;
            if(item.style) el.style.cssText += item.style;
            
            el.dataset.origLeft = item.x + '%';
            el.dataset.origTop = item.y + '%';
            el.dataset.origText = item.text || '';
            el.dataset.origTransform = 'none';
            
            parent.appendChild(el);
        }

        function addRandomClutter(roomDiv, roomId) {
            const symbols = ['‚úñ', '‚óè', '‚ñ†', '‚ñ≤', '‚ô•', '‚òÖ', '‚ô¶', '‚ò∫'];
            for(let i=0; i<3; i++) {
                const s = document.createElement('div');
                s.className = 'obj deco-emoji';
                s.innerText = symbols[Math.floor(Math.random()*symbols.length)];
                s.style.left = (Math.random()*90) + '%';
                s.style.top = (Math.random()*50 + 10) + '%';
                s.style.color = 'rgba(255,255,255,0.2)';
                s.id = `r${roomId}-deco${i}`; 
                roomDiv.appendChild(s);
            }
        }

        /* --- GAME LOGIC --- */
        function startLevel(lvl) {
            currentLevel = lvl;
            document.getElementById('level-indicator').innerText = `LVL ${lvl}/${MAX_LEVEL}`;
            document.getElementById('status-display').innerText = "SYSTEM REBOOT...";
            document.getElementById('status-display').style.color = "#888";
            
            resetRooms();
            if(anomalyTimer) clearTimeout(anomalyTimer);

            const st = document.getElementById('static');
            st.style.opacity = 1;
            AudioSys.play('static');
            
            setTimeout(() => {
                st.style.opacity = 0.08;
                document.getElementById('status-display').innerText = "MONITORING...";
                document.getElementById('status-display').style.color = "#0f0";
                scheduleAnomaly();
            }, 1000);
        }

        function resetRooms() {
            document.querySelectorAll('.temp-anomaly').forEach(el => el.remove());
            document.querySelectorAll('.obj').forEach(el => {
                if(el.dataset.origLeft) el.style.left = el.dataset.origLeft;
                if(el.dataset.origTop) el.style.top = el.dataset.origTop;
                if(el.dataset.origText) el.innerText = el.dataset.origText;
                el.style.transform = 'none';
                el.style.opacity = el.className.includes('deco') ? 0.7 : 1;
                el.style.filter = 'none';
                el.style.color = '';
                el.classList.remove('scary-text');
                el.style.display = 'flex';
            });
            document.querySelectorAll('.room-container').forEach(r => {
                r.classList.remove('scary-filter');
                r.classList.remove('blood-filter');
            });
            anomalyData = { active: false, type: 'none', roomId: -1, description: '' };
        }

        function scheduleAnomaly() {
            if(Math.random() > 0.4) {
                // –ê–Ω–æ–º–∞–ª–∏—è —á–µ—Ä–µ–∑ 2-7 —Å–µ–∫
                const delay = Math.random() * 5000 + 2000;
                anomalyTimer = setTimeout(triggerAnomaly, delay);
                anomalyData.pending = true; 
            } else {
                anomalyData.type = 'none';
                anomalyData.active = false;
                anomalyData.pending = false;
            }
        }

        function triggerAnomaly() {
            if(isGameOver) return;
            
            anomalyData.pending = false;
            anomalyData.active = true;
            
            const roomId = Math.floor(Math.random() * 6);
            const roomEl = document.getElementById(`room-${roomId}`);
            const allObjs = Array.from(roomEl.querySelectorAll('.obj')); 
            const target = allObjs[Math.floor(Math.random() * allObjs.length)];
            const roomName = ROOM_LAYOUTS[roomId].name;

            anomalyData.roomId = roomId;

            const types = ['ghost', 'move', 'extra', 'missing', 'emoji', 'text', 'camera', 'intruder'];
            const type = types[Math.floor(Math.random() * types.length)];
            anomalyData.type = type;

            switch(type) {
                case 'ghost': 
                    const g = document.createElement('div');
                    g.className = 'ghost temp-anomaly';
                    g.style.left = (Math.random()*80 + 10) + '%';
                    g.style.top = (Math.random()*20 + 30) + '%';
                    roomEl.appendChild(g);
                    anomalyData.description = `–¢–µ–Ω—å –≤: ${roomName}`;
                    break;
                
                case 'move':
                    if(target) {
                        target.style.transform = `rotate(${Math.random()*20 - 10}deg) translate(20px, 0)`;
                        anomalyData.description = `–î–≤–∏–∂–µ–Ω–∏–µ –≤: ${roomName}`;
                    }
                    break;
                
                case 'extra':
                    const ex = document.createElement('div');
                    ex.className = 'obj temp-anomaly';
                    const extras = ['üî™', 'ü©∏', 'ü¶∂', 'üëÅÔ∏è', 'üé©'];
                    ex.innerText = extras[Math.floor(Math.random()*extras.length)];
                    ex.style.fontSize = '6vh';
                    ex.style.left = (Math.random()*80 + 10) + '%';
                    ex.style.top = (Math.random()*50 + 40) + '%';
                    ex.style.zIndex = 20;
                    roomEl.appendChild(ex);
                    anomalyData.description = `–ü—Ä–µ–¥–º–µ—Ç –≤: ${roomName}`;
                    break;

                case 'missing':
                    if(target) {
                        target.style.opacity = 0;
                        anomalyData.description = `–ü—Ä–æ–ø–∞–∂–∞ –≤: ${roomName}`;
                    }
                    break;

                case 'emoji':
                    const emojiObjs = allObjs.filter(o => o.innerText && o.innerText.match(/\p{Emoji}/u));
                    const emoTarg = emojiObjs.length > 0 ? emojiObjs[Math.floor(Math.random()*emojiObjs.length)] : target;
                    if(emoTarg) {
                        emoTarg.innerText = ['üòà', '‚ò†Ô∏è', 'üò°', 'üëπ'][Math.floor(Math.random()*4)];
                        emoTarg.classList.add('scary-text');
                        anomalyData.description = `–õ–∏—Ü–æ –≤: ${roomName}`;
                    }
                    break;

                case 'text':
                    const textObjs = allObjs.filter(o => o.classList.contains('poster'));
                    if(textObjs.length > 0) {
                        const t = textObjs[0];
                        t.innerText = ['DIE', 'RUN', 'HELL', 'WATCH'][Math.floor(Math.random()*4)];
                        t.classList.add('scary-text');
                        anomalyData.description = `–ù–∞–¥–ø–∏—Å—å –≤: ${roomName}`;
                    } else {
                        const txt = document.createElement('div');
                        txt.className = 'obj temp-anomaly scary-text';
                        txt.innerText = "I SEE YOU";
                        txt.style.color = "red";
                        txt.style.fontSize = "4vh";
                        txt.style.top = "10%"; txt.style.left = "30%";
                        roomEl.appendChild(txt);
                        anomalyData.description = `–ù–∞–¥–ø–∏—Å—å –≤: ${roomName}`;
                    }
                    break;

                case 'camera':
                    if(Math.random() > 0.5) roomEl.classList.add('scary-filter');
                    else roomEl.classList.add('blood-filter');
                    anomalyData.description = `–ö–∞–º–µ—Ä–∞ —Å–±–æ–∏—Ç: ${roomName}`;
                    break;

                case 'intruder':
                    const win = roomEl.querySelector('.window');
                    if(win) {
                        const face = document.createElement('div');
                        face.className = 'intruder-face temp-anomaly';
                        face.innerText = 'üòê';
                        win.appendChild(face);
                        anomalyData.description = `–í –æ–∫–Ω–µ: ${roomName}`;
                    } else {
                        triggerAnomaly(); return;
                    }
                    break;
            }
        }

        /* --- UI HANDLERS --- */
        function switchCam(id) {
            document.querySelectorAll('.cam-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.cam-btn')[id].classList.add('active');
            
            document.querySelectorAll('.room-container').forEach(r => r.classList.remove('visible'));
            document.getElementById(`room-${id}`).classList.add('visible');
            
            currentCam = id;
            document.getElementById('cam-info').innerText = `CAM ${id+1}`;
            AudioSys.play('static');
        }

        function toggleReport() {
            const el = document.getElementById('report-overlay');
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
        }

        function checkAnswer(userChoice) {
            document.getElementById('report-overlay').style.display = 'none';
            
            if(userChoice === 'none') {
                if(anomalyData.active || anomalyData.pending) {
                    gameOver(false, anomalyData.active ? anomalyData.description : "–°–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ! –ê–Ω–æ–º–∞–ª–∏—è –ø–æ—è–≤–∏–ª–∞—Å—å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç—á–µ—Ç–∞.");
                } else {
                    nextLevel();
                }
                return;
            }

            if(!anomalyData.active) {
                gameOver(false, "–õ–æ–∂–Ω—ã–π –≤—ã–∑–æ–≤. –ê–Ω–æ–º–∞–ª–∏–π –Ω–µ –±—ã–ª–æ.");
                return;
            }

            if(anomalyData.roomId !== currentCam) {
                gameOver(false, `–û—à–∏–±–∫–∞ –∫–æ–º–Ω–∞—Ç—ã. –ê–Ω–æ–º–∞–ª–∏—è –±—ã–ª–∞ –≤: ${ROOM_LAYOUTS[anomalyData.roomId].name}.`);
                return;
            }

            if(anomalyData.type !== userChoice) {
                gameOver(false, `–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø. –≠—Ç–æ –±—ã–ª–æ: ${anomalyData.description}`);
                return;
            }

            nextLevel();
        }

        function nextLevel() {
            AudioSys.play('good');
            if(currentLevel >= MAX_LEVEL) {
                gameOver(true, "");
            } else {
                startLevel(currentLevel + 1);
            }
        }

        function gameOver(win, reason) {
            isGameOver = true;
            if(anomalyTimer) clearTimeout(anomalyTimer);
            
            const scr = document.getElementById('fullscreen-msg');
            const title = document.getElementById('msg-title');
            const body = document.getElementById('msg-body');
            
            scr.style.display = 'flex';
            
            if(win) {
                title.style.color = '#0f0';
                title.innerText = "–°–ú–ï–ù–ê –°–î–ê–ù–ê";
                body.innerHTML = "–í–´ –í–´–ñ–ò–õ–ò.<br>–í–°–ï –ß–ò–°–¢–û.";
                AudioSys.play('good');
            } else {
                title.style.color = 'red';
                title.innerText = "–í–´ –ú–ï–†–¢–í–´";
                body.innerHTML = `<span style="color:white;">–ü–†–ò–ß–ò–ù–ê:</span><br>${reason}<br><br><span style="color:#555">LVL: ${currentLevel}</span>`;
                AudioSys.play('bad');
            }
        }
    </script>
</body>
</html>
